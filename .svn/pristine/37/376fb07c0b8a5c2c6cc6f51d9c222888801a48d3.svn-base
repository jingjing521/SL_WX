<!doctype html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta content="width=device-width, minimum-scale=1,initial-scale=1, maximum-scale=1, user-scalable=1;" id="viewport" name="viewport" />
		<!--离线应用的另一个技巧-->
		<meta content="yes" name="apple-mobile-web-app-capable" />
		<!--指定的iphone中safari顶端的状态条的样式-->
		<meta content="black" name="apple-mobile-web-app-status-bar-style" />
		<!--告诉设备忽略将页面中的数字识别为电话号码-->
		<meta content="telephone=no" name="format-detection" />
		<title>商家认证</title>
		<link rel="stylesheet" type="text/css" href="css/index.css" />
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<link rel="stylesheet" href="css/weui.min.css">
		<link rel="stylesheet" href="css/jquery-weui.css">
	</head>

	<body>
		<!-- 总体框架 -->
		<div class="index-bg">
			<div id="merchantsCert">
				<div class="merchantsCert-top">
					<div class="merchantsCert-item">
						<div class="fl merchantsCert-item-name">店铺名称：</div>
						<div class="fl merchantsCert-item-con"><input type="text" placeholder="请输入店铺名称" value="" class="name" /></div>
						<div class="clear"></div>
					</div>
					<div class="merchantsCert-item">
						<div class="fl merchantsCert-item-name">联系人姓名：</div>
						<div class="fl merchantsCert-item-con"><input type="text" placeholder="请输入联系人姓名" value="" class="contact_name" /></div>
						<div class="clear"></div>
					</div>
					<div class="merchantsCert-item">
						<div class="fl merchantsCert-item-name">性别：</div>
						<div class="fl merchantsCert-item-con">
							<div class="fl  ssex" style="line-height: 50px;">
 								<div class="commodity fl select n" sid="1"></div>男
							</div>
							<div class="fl ml20 ssex" style="line-height: 50px;">
 								<div class="commodity fl v" sid="2"></div>女
							</div>
							
							<div class="clear"></div>
						</div>
						<div class="clear"></div>
					</div>
					<div class="merchantsCert-item">
						<div class="fl merchantsCert-item-name">公司地址：</div>
						<input class=" fl  dq" id="start" type="text" placeholder="请选择地区" value="" style="width: 62%; line-height: 50px; border: none;">
						<img class=" fl" src="images/bottom.png" style="width: 30px; margin-top: 10px;">
						<div class="clear"></div>
					</div>
					<div class="merchantsCert-item">
						<div class=" merchantsCert-item-con" style="width: 100%; padding-bottom: 8px;"><input type="text" placeholder="请输入公司详细地址" value="" class="address" /></div>
						<div class="clear"></div>
					</div>
					<div class="merchantsCert-item">
						<div class="fl merchantsCert-item-name">手机号码：</div>
						<div class="fl merchantsCert-item-con"><input type="text" placeholder="请输入手机号码" value="" class="phone" maxlength="11" onkeypress="if(!this.value.match(/^[\+\-]?\d*?\.?\d*?$/))this.value=this.t_value;else this.t_value=this.value;if(this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?)?$/))this.o_value=this.value" onkeyup="if(!this.value.match(/^[\+\-]?\d*?\.?\d*?$/))this.value=this.t_value;else this.t_value=this.value;if(this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?)?$/))this.o_value=this.value" onblur="if(!this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?|\.\d*?)?$/))this.value=this.o_value;else{if(this.value.match(/^\.\d+$/))this.value=0+this.value;if(this.value.match(/^\.$/))this.value=0;this.o_value=this.value}"></div>
						<div class="clear"></div>
					</div>
					<div class="merchantsCert-item bbn">
						<div class="merchantsCert-item-name">联系电话：</div>
						<div class=" merchantsCert-item-con" style="width: 100%;">
							<div class="fl" style="width: 25%; "><input type="text" placeholder="输入区号" maxlength="4" class="qh" style="width: 90%; text-align: center; margin: auto; line-height: 50px;" onkeypress="if(!this.value.match(/^[\+\-]?\d*?\.?\d*?$/))this.value=this.t_value;else this.t_value=this.value;if(this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?)?$/))this.o_value=this.value" onkeyup="if(!this.value.match(/^[\+\-]?\d*?\.?\d*?$/))this.value=this.t_value;else this.t_value=this.value;if(this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?)?$/))this.o_value=this.value" onblur="if(!this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?|\.\d*?)?$/))this.value=this.o_value;else{if(this.value.match(/^\.\d+$/))this.value=0+this.value;if(this.value.match(/^\.$/))this.value=0;this.o_value=this.value}"></div>
							<div class="fl" style="line-height: 50px; width: 5%;">——</div>
							<div class="fl" style="width: 32%;"><input type="text" placeholder="输入总机号" maxlength="8" class="zjh" style="width: 90%; text-align: center; margin: auto; line-height: 50px;" onkeypress="if(!this.value.match(/^[\+\-]?\d*?\.?\d*?$/))this.value=this.t_value;else this.t_value=this.value;if(this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?)?$/))this.o_value=this.value" onkeyup="if(!this.value.match(/^[\+\-]?\d*?\.?\d*?$/))this.value=this.t_value;else this.t_value=this.value;if(this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?)?$/))this.o_value=this.value" onblur="if(!this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?|\.\d*?)?$/))this.value=this.o_value;else{if(this.value.match(/^\.\d+$/))this.value=0+this.value;if(this.value.match(/^\.$/))this.value=0;this.o_value=this.value}"></div>
							<div class="fl" style="line-height: 50px; width: 5%;">——</div>
							<div class="fl" style="width: 32%; "><input type="text" placeholder="输入分机号" maxlength="4" class="fjh" style="width: 90%; text-align: center;  margin: auto; line-height: 50px;" onkeypress="if(!this.value.match(/^[\+\-]?\d*?\.?\d*?$/))this.value=this.t_value;else this.t_value=this.value;if(this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?)?$/))this.o_value=this.value" onkeyup="if(!this.value.match(/^[\+\-]?\d*?\.?\d*?$/))this.value=this.t_value;else this.t_value=this.value;if(this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?)?$/))this.o_value=this.value" onblur="if(!this.value.match(/^(?:[\+\-]?\d+(?:\.\d+)?|\.\d*?)?$/))this.value=this.o_value;else{if(this.value.match(/^\.\d+$/))this.value=0+this.value;if(this.value.match(/^\.$/))this.value=0;this.o_value=this.value}"></div>
							<div class="clear"></div>
						</div>
						<div class="clear"></div>
					</div>
				</div>		
				
				<div class="merchantsCert-bottom mt10 pb">
					<div class="merchantsCert-items">
						<div class="fl">添加企业营业执照或三证合一证</div>
						<div class="fl ml50">示例照片</div>
						<div class="clear"></div>
					</div>
					<div class="merchantsCert-bottom-upload">
						<div class="con4 fl" style="margin-top: 20px !important;">
		                    <canvas id="cvs" width="200" height="200" class="fr"></canvas>
		                    <form id="forms" enctype="multipart/form-data" target="id_iframe" method="post" action="http://qcap.hangtuosoft.com/index.php?g=asset&m=asset&a=swfupload">
			                    <span class="btn upload"><input type="file" name="img" accept="image/*" capture="camera" class="upload_pic" id="upload" /></span>
			                    <div class="clear"></div>
			               		<input type="submit" value="提交" style="display: none;">
		                    </form>
		                    <iframe id="id_iframe" name="id_iframe" style="display:none;"></iframe> 
		                     <div class="clear"></div>
		                </div>
						<div class="fl merchantsCert-bottom-uploadr ml20"><img src="images/zyz.png" class="mings"></div>
						<div class="clear"></div>
					</div>
					<div class="merchantsCert-bottom-phone">
						<img src="images/l-phone.png" /><a href="tel:12345678">一键咨询电话：400-12345678</a>
					</div>
					<div class="btn1 btn">提交</div>
				</div>
			</div>
		</div>
	</body>
	<script src="js/jquery-2.2.1.js"></script>
	<script type="text/javascript" src="js/center.js" ></script>
	<script type="text/javascript" src="js/md5.js" ></script>
    <script src="js/fastclick.js"></script>
	<script src="js/jquery-weui.js"></script>
    <script src="js/city-pickers.js"></script>
    <script>
     $(function() {
	    FastClick.attach(document.body);
	  });
    	$("#start").cityPicker({
        title: "选择地区",
        onChange: function (picker, values, displayValues) {
          console.log(values, displayValues);
        }
      });
    </script>
    <script>
//user_id	Int(11)	用户id	Y	
//name	String	店铺名称	Y	 
//contact_name	String	联系人姓名	N	
//img	File	营业执照	Y	
//contact_tel	String	联系电话	N	格式029-8650501-23（区号-电话-分机号）
//phone	String	手机号码	N	
//province	Int	省id	Y	
//city	Int	市id	Y	
//district	Int	区县id	Y	
//address	String	详细地址	Y	
//sex	Int	性别	Y	1男 2女
//key	String	秘钥key	Y	
//timestamp	Int(11)	时间戳	Y	
//sign	String	签名	Y	
			var id;
			$(".merchantsCert-item-con").on("click",".commodity",function(){
				$(".commodity").removeClass("select");
				$(this).addClass("select");				
			});
    		window.onload=function(){  
                 changeWindowWidth();  
            }  
            //当浏览器窗口大小改变时，设置显示内容的高度  
            window.onresize=function(){  
                 changeWindowWidth();  
            }  
            function changeWindowWidth(){               
                var w = $(window).width();//获取页面可见宽度  
                var imgw=$(".webuploader-pick").height();
                var iw=$(".mings").height();
                console.log(iw);
                $(".webuploader-pick").css("height",iw);
                $(".imgWrap img").css("height",iw);
            }
            
            $(document).ready(function(){
            	var h=$(window).height();
            	var hh=$(".merchantsCert-top").height();
            	var hhh=parseInt(h-hh);
            	$(".merchantsCert-bottom").css("min-height",hhh);
            	var id;
            	var a;
            	var user_id=localStorage.getItem("user_id");
				var timestamp1 = Date.parse(new Date());
		 		var values1=["user_id","timestamp"];
				var data1={"user_id":user_id,"timestamp":timestamp1};
				var sign1 = doSign(values1,data1);
				var keys="idf5nsi5t0qbemwo12hztbftm53tbv6pht";
				$.ajax({
					type:"post",
					url: link_url+"shopAuthDetail",
					dataType: "json",
					data: {"user_id":user_id,"key":keys,"timestamp":timestamp1,"sign":sign1},
					success: function(data) {
					    if(data.status == 1){
					        console.log(data);
					        var v=data.data;
					        $(".name").val(v.name);
					        $(".contact_name").val(v.contact_name);
					        if(v.sex==1){
					        	$(".commodity").removeClass("select");
					        	$(".n").addClass("select");
					        }else{
					        	$(".commodity").removeClass("select");
					        	$(".v").addClass("select");
					        }
					        $(".dq").val(v.province_name+v.city_name+v.district_name);
					        var data_codes=v.province+","+v.city+","+v.district;
					        $(".dq").attr("data-codes",data_codes);
					        $(".address").val(v.address);
					        $(".phone").val(v.phone);
					        var lx=v.contact_tel;
					        var first=lx.indexOf("-");
					        var last=lx.lastIndexOf("-");
					        var str=lx.substr(0,first);
					        var str1=lx.slice(first+1,last);
					        var str2=lx.slice(last+1);
					        $(".qh").val(str);
					        $(".zjh").val(str1);
					        $(".fjh").val(str2);
					        $("#id_iframe").attr("img",v.img);
					        images(v.img);
					        id=v.id;
					        console.log(id);
							
							$(".btn1").click(function(){
				            	var name=$(".name").val();
				            	var contact_name=$(".contact_name").val()||"";
				            	var qh=$(".qh").val();
				            	var zjh=$(".zjh").val();
				            	var fjh=$(".fjh").val();
				            	var str=qh+"-"+zjh+"-"+fjh;
				            	var contact_tel=str||"";
				            	var phone=$(".phone").val()||"";
				            	var address=$(".address").val();
				            	var sex=$(".select").attr("sid");
				            	var dq=$(".dq").val();
				            	console.log(contact_tel);
								var fromtype = "pc";
								var regx = /^(13[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(18[0-9]{9})|(15[0-9]{9})$/;
								
								if(name==""){
									$.toast("请输入店铺名称!", "text");
								 	return false;
								}else if(contact_name==""){
									$.toast("请输入联系人姓名!", "text");
								 	return false;
								}else if(dq==""){
									$.toast("请选择地区!", "text");
								 	return false;
								}else if(address==""){
									$.toast("请输入详细地址!", "text");
								 	return false;
								}else if(phone.length==""){
									$.toast("请输入手机号码!", "text");
									return false;
								}else if(phone.length < 11 || !regx.test(phone)||phone.length > 11){
									$.toast("请输入正确的手机号码!", "text");
								 	return false;
								} else if(qh == ""&&zjh==""&&fjh=="") {
									$.toast("请输入联系电话!", "text");
									return false;
								} else if(qh == ""||zjh==""||fjh=="") {
									$.toast("请输入联系电话!", "text");
									return false;
								} else{
									var hq=$(".dq").attr("data-codes");
					            	var arr=new Array();
									arr=hq.split(",");
					            	var province=parseInt(arr[0]);
					            	var city=parseInt(arr[1]);
					            	var district=parseInt(arr[2]);
									
									var obj=document.getElementById("id_iframe").contentWindow; 
									console.log(obj);
									var obji1=obj.document.getElementsByTagName("body"); 
									var obji2=obj.document.getElementsByTagName("body")[0].innerText; 
									console.log(obji2);
									var img1=$.parseJSON(obji2);
									var imgs=img1.url;
									var images=imgs.replace("\/", "/");
									console.log(images);
									 $("#id_iframe").attr("img",images);
									var img=$("#id_iframe").attr("img");
									
					            	var timestamp1 = Date.parse(new Date());
						 			 var values1=["id","user_id","name","fromtype","contact_name","contact_tel","phone","city","sex","address","district","province","timestamp"];
									 var data1={"id":id,"user_id":user_id,"name":name,"fromtype":fromtype,"contact_name":contact_name,"contact_tel":contact_tel,"phone":phone,"city":city,"sex":sex,"address":address,"district":district,"province":province,"timestamp":timestamp1};
									 var sign1 = doSign(values1,data1);
									 var keys="idf5nsi5t0qbemwo12hztbftm53tbv6pht";
									 $.ajax({
										type:"post",
										url: link_url+"shopAuthEdit",
										dataType: "json",
									    data: {"id":id,"user_id":user_id,"name":name,"fromtype":fromtype,"contact_name":contact_name,"img":img,"contact_tel":contact_tel,"phone":phone,"city":city,"sex":sex,"address":address,"district":district,"province":province,"key":keys,"timestamp":timestamp1,"sign":sign1},
										success: function(data) {
										    if(data.status == 1){
										        console.log(data);
										        window.location.href="center.html";
										    }else{
										       $.toast(data.data, "text");
										       console.log(data);
										    }
										},
										error:function(){
										   
										}
									 })
								}
				            })
					    }else{
					       console.log(data);
					    }
					},
					error:function(){
					   
					}
				})
				
            
            	
            })
            
            
        var input1 = document.getElementById("upload"); 
		if(typeof FileReader==='undefined'){ 
		     //result.innerHTML = "抱歉，你的浏览器不支持 FileReader"; 
		     input1.setAttribute('disabled','disabled'); 
		}else{ 
		     input1.addEventListener('change',readFile,false); 
		     
		}
		function images(src){
			var image = new Image();
			// 设置src属性 
				image.src = src;
				var max=200;
				// 绑定load事件处理器，加载完成后执行，避免同步问题
				image.onload = function(){ 
					// 获取 canvas DOM 对象 
					var canvas = document.getElementById("cvs"); 
					var ctx = canvas.getContext("2d"); 
					// canvas清屏 
					ctx.clearRect(0, 0, canvas.width, canvas.height); 
					ctx.drawImage(image, 0, 0, 200, 200);
					// 注意，此时image没有加入到dom之中
					$("#forms").submit();
					
				};  
		}
		function readFile(){ 
			var file = this.files[0];//获取上传文件列表中第一个文件
			if(!/image\/\w+/.test(file.type)){
			//图片文件的type值为image/png或image/jpg
				alert("文件必须为图片！");
				return false; 
			} 
			// console.log(file);
			var reader = new FileReader();//实例一个文件对象
			reader.readAsDataURL(file);//把上传的文件转换成url
			//当文件读取成功便可以调取上传的接口
			
			
			reader.onload = function(e){ 
				var image = new Image();
				// 设置src属性 
				image.src = e.target.result;
				var max=200;
				// 绑定load事件处理器，加载完成后执行，避免同步问题
				image.onload = function(){ 
					// 获取 canvas DOM 对象 
					var canvas = document.getElementById("cvs"); 
					var ctx = canvas.getContext("2d"); 
					// canvas清屏 
					ctx.clearRect(0, 0, canvas.width, canvas.height); 
					ctx.drawImage(image, 0, 0, 200, 200);
					// 注意，此时image没有加入到dom之中
					$("#forms").submit();
					
				};  
			}
		};
    </script>
</html>